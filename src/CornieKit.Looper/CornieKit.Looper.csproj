<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
    <ApplicationIcon>favicon.ico</ApplicationIcon>

    <Version>1.3.0</Version>
    <AssemblyVersion>1.3.0.0</AssemblyVersion>
    <FileVersion>1.3.0.0</FileVersion>
    <Company>CornieKit</Company>
    <Product>CornieKit Looper</Product>
    <Description>Video Segment Loop Player - Mark and loop video segments with ease</Description>
    <PublishReadyToRun>true</PublishReadyToRun>
  </PropertyGroup>

  <ItemGroup>
    <Resource Include="Assets\Icons\*.png" />
    <!-- Compiled pixel shader — generated by CompilePixelShaders target below -->
    <Content Include="Effects\VideoAdjust.ps"
             Condition="Exists('$(MSBuildProjectDirectory)Effects\VideoAdjust.ps')">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
    </Content>
  </ItemGroup>

  <!-- Auto-compile HLSL shader (no Inputs/Outputs — always recompile to guarantee ps_3_0 output) -->
  <Target Name="CompilePixelShaders"
          BeforeTargets="CoreCompile">
    <PropertyGroup>
      <!-- 1. Use VS-provided Windows SDK paths -->
      <_FxcExe Condition="Exists('$(WindowsSdkDir)bin\$(WindowsSDKVersion)x64\fxc.exe')">$(WindowsSdkDir)bin\$(WindowsSDKVersion)x64\fxc.exe</_FxcExe>
      <_FxcExe Condition="'$(_FxcExe)' == '' And Exists('$(WindowsSdkBinPath)x64\fxc.exe')">$(WindowsSdkBinPath)x64\fxc.exe</_FxcExe>
    </PropertyGroup>
    <!-- 2. PowerShell fallback: find latest fxc.exe in Program Files -->
    <Exec Condition="'$(_FxcExe)' == ''"
          Command="powershell -NoProfile -Command &quot;(Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin' -Recurse -Filter fxc.exe -ErrorAction SilentlyContinue | Where-Object { $_.DirectoryName -match 'x64' } | Sort-Object FullName -Descending | Select-Object -First 1).FullName&quot;"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="_FxcExe"/>
    </Exec>
    <Error Condition="'$(_FxcExe)' == '' Or !Exists('$(_FxcExe)')"
           Text="fxc.exe not found. Install Windows SDK, or set _FxcExe manually in CornieKit.Looper.csproj."/>
    <Exec Command="&quot;$(_FxcExe)&quot; /T ps_3_0 /E main /Fo &quot;$(MSBuildProjectDirectory)\Effects\VideoAdjust.ps&quot; &quot;$(MSBuildProjectDirectory)\Effects\VideoAdjust.fx&quot;"/>
    <!-- Explicitly copy to output dir (handles first-build where static Content Condition was false) -->
    <MakeDir Directories="$(OutDir)Effects"/>
    <Copy SourceFiles="$(MSBuildProjectDirectory)\Effects\VideoAdjust.ps"
          DestinationFolder="$(OutDir)Effects"/>
  </Target>

  <!-- Always copy the compiled shader to the output dir, even when CompilePixelShaders is skipped
       by incremental-build optimisation (i.e. .ps already newer than .fx). -->
  <Target Name="CopyShaderToOutput" AfterTargets="Build"
          Condition="Exists('$(MSBuildProjectDirectory)Effects\VideoAdjust.ps')">
    <MakeDir Directories="$(OutDir)Effects"/>
    <Copy SourceFiles="$(MSBuildProjectDirectory)Effects\VideoAdjust.ps"
          DestinationFolder="$(OutDir)Effects"
          SkipUnchangedFiles="true"/>
  </Target>

  <ItemGroup>
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
    <PackageReference Include="LibVLCSharp" Version="3.9.5" />
    <PackageReference Include="LibVLCSharp.WPF" Version="3.9.5" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="10.0.2" />
    <PackageReference Include="VideoLAN.LibVLC.Windows" Version="3.0.23" />
  </ItemGroup>

</Project>
